<ion-content [fullscreen]="true" class="ion-padding-top ion-padding">

  <div class="header-section">
    <h2>Apple Health Task</h2>
    <p class="status-message" [innerHTML]="statusMessage">
    </p>

    <!-- Network Status Indicator -->
    <div class="network-status" *ngIf="!isProcessing">
      <ion-icon [name]="isNetworkConnected ? 'wifi' : 'wifi-outline'"
        [color]="isNetworkConnected ? 'success' : 'danger'">
      </ion-icon>
      <span class="network-text" [class]="isNetworkConnected ? 'connected' : 'disconnected'">
        {{ networkStatusInfo }}
      </span>
    </div>
  </div>

  <ion-card *ngIf="showProgressBar">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="analytics" *ngIf="currentProgress.status !== 'error'"></ion-icon>
        <ion-icon name="alert-circle" color="danger" *ngIf="currentProgress.status === 'error'"></ion-icon>
        Processing Status
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="attempt-container" *ngIf="isProcessing && attemptProgress.cacheSize > 0">
        <div class="attempt-text">
          Sending {{ attemptProgress.success + attemptProgress.failed }}/{{ attemptProgress.cacheSize }} records
        </div>
      </div>
      <div class="progress-container">
        <ion-progress-bar [value]="currentProgress.progress / 100"
          [color]="currentProgress.status === 'error' ? 'danger' : (currentProgress.status === 'complete' ? 'success' : 'primary')">
        </ion-progress-bar>
        <div class="progress-text">
          <span class="progress-percentage">{{ currentProgress.progress }}%</span>
        </div>

        <div class="progress-details" *ngIf="currentProgress.message">
          <div class="progress-row">
            <ion-spinner *ngIf="isProcessing" name="lines" color="primary"
              class="progress-inline-spinner"></ion-spinner>
            <div class="progress-status" [innerHTML]="currentProgress.message"></div>
          </div>
        </div>
      </div>

      <div class="error-status" *ngIf="currentProgress.status === 'error'">
        <ion-icon name="alert-circle" color="danger" size="large"></ion-icon>
        <span>An error occurred during processing</span>
      </div>
    </ion-card-content>
  </ion-card>


  <div class="action-buttons">
    <ion-button ion-button class="bt bt--full" round full *ngIf="canStartProcessing" expand="block" size="large"
      color="primary" (click)="startHealthDataCollection()">
      Tap to Start Data Pull
    </ion-button>

    <ng-container *ngIf="showRetryButton">
      <ion-button ion-button class="bt bt--full retry-button" round full expand="block" size="large" color="primary"
        (click)="retryProcessing()">
        Retry
      </ion-button>
    </ng-container>
  </div>

</ion-content>


<ion-footer>
  <ion-toolbar>
    <ion-button ion-button slot="start" icon-left [disabled]="isProcessing" (click)="exitTask()">
      <ion-icon name="close"></ion-icon>
      <div class="toolbar-label">Close</div>
    </ion-button>
  </ion-toolbar>
</ion-footer>